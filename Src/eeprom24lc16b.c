/*
  Settings.c - eeprom configuration handling
  Part of Grbl-Advanced

  Copyright (c) 2011-2016 Sungeun K. Jeon for Gnea Research LLC
  Copyright (c) 2009-2011 Simen Svale Skogsrud
  Copyright (c)	2017 Patrick F.

  Grbl-Advanced is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Grbl-Advanced is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Grbl-Advanced.  If not, see <http://www.gnu.org/licenses/>.
*/

#include "Print.h"
#include "eeprom24lc16b.h"
#include "i2c.h"
#include "System32.h"

#define EEPROM_PAGE_SIZE 16

static uint8_t test_array[1024] = {101, 70, 246, 52, 126, 234, 197, 236, 169, 177, 249, 4, 83, 214, 138, 178, 64, 142,
                                   78, 134, 148, 156, 81, 53, 118, 188, 117, 119, 210, 205, 133, 2, 211, 187, 112, 222,
                                   246, 62, 37, 101, 107, 18, 61, 0, 245, 227, 111, 86, 169, 131, 242, 107, 64, 254,
                                   96, 100, 84, 187, 27, 146, 50, 43, 3, 61, 243, 48, 224, 25, 194, 199, 183, 94, 13,
                                   68, 249, 144, 237, 241, 224, 58, 99, 97, 115, 191, 155, 63, 20, 251, 41, 146, 39,
                                   151, 107, 36, 114, 70, 179, 152, 237, 5, 94, 75, 41, 31, 138, 201, 8, 13, 241, 62,
                                   63, 10, 81, 74, 109, 3, 47, 94, 209, 172, 139, 197, 240, 250, 28, 114, 183, 43, 133,
                                   50, 116, 157, 99, 37, 157, 112, 53, 59, 140, 175, 234, 174, 181, 249, 51, 200, 249,
                                   200, 182, 57, 86, 194, 51, 82, 189, 202, 185, 47, 47, 33, 230, 25, 87, 201, 43, 127,
                                   230, 199, 93, 251, 72, 204, 208, 100, 106, 240, 100, 108, 168, 120, 234, 113, 99,
                                   155, 121, 168, 174, 159, 8, 70, 143, 72, 37, 203, 135, 98, 171, 159, 248, 200, 232,
                                   242, 10, 246, 237, 188, 191, 209, 183, 70, 70, 34, 128, 31, 97, 221, 222, 49, 107,
                                   123, 241, 63, 199, 219, 242, 211, 71, 96, 55, 216, 196, 190, 150, 215, 135, 251, 82,
                                   157, 35, 100, 118, 188, 5, 113, 194, 181, 146, 241, 52, 21, 143, 85, 231, 230, 160,
                                   192, 136, 181, 168, 34, 10, 157, 28, 126, 156, 164, 100, 241, 26, 64, 225, 57, 203,
                                   2, 125, 94, 104, 55, 146, 221, 128, 202, 132, 46, 8, 126, 206, 234, 182, 68, 73, 10,
                                   41, 71, 103, 124, 56, 39, 174, 136, 159, 159, 135, 231, 140, 5, 179, 29, 144, 208,
                                   161, 59, 90, 3, 59, 140, 128, 90, 249, 231, 65, 56, 62, 243, 108, 18, 202, 77, 68,
                                   117, 144, 253, 157, 131, 190, 248, 146, 76, 127, 10, 208, 174, 20, 83, 111, 83, 61,
                                   8, 18, 204, 98, 121, 250, 38, 217, 48, 208, 250, 208, 204, 152, 18, 175, 195, 149,
                                   252, 216, 41, 163, 26, 141, 134, 229, 132, 70, 201, 236, 144, 239, 42, 208, 165, 47,
                                   126, 246, 199, 140, 168, 199, 98, 177, 83, 199, 224, 126, 71, 165, 1, 103, 5, 220,
                                   246, 111, 102, 27, 40, 248, 109, 159, 159, 82, 172, 149, 98, 12, 8, 44, 197, 192,
                                   123, 183, 226, 135, 48, 32, 246, 82, 218, 48, 114, 188, 190, 174, 92, 36, 123, 135,
                                   135, 76, 15, 94, 167, 2, 68, 77, 17, 189, 12, 196, 44, 142, 181, 238, 206, 82, 216,
                                   250, 154, 52, 88, 113, 86, 158, 242, 212, 163, 138, 113, 185, 131, 181, 111, 72, 95,
                                   88, 133, 55, 113, 229, 114, 40, 42, 76, 174, 60, 220, 163, 160, 155, 132, 82, 252,
                                   136, 83, 152, 218, 158, 232, 182, 230, 224, 4, 219, 169, 146, 236, 236, 246, 144,
                                   91, 137, 212, 119, 190, 130, 168, 163, 179, 166, 108, 111, 45, 175, 32, 91, 29, 218,
                                   195, 121, 37, 46, 82, 224, 211, 156, 145, 102, 137, 79, 234, 151, 212, 26, 74, 96,
                                   81, 118, 172, 136, 73, 174, 144, 129, 53, 117, 178, 231, 203, 210, 152, 242, 168,
                                   17, 80, 162, 222, 168, 115, 145, 240, 36, 102, 144, 74, 120, 82, 144, 176, 68, 214,
                                   52, 248, 102, 150, 229, 185, 8, 64, 153, 104, 248, 49, 227, 141, 225, 29, 146, 69,
                                   216, 12, 123, 161, 50, 146, 172, 151, 77, 150, 27, 99, 179, 52, 166, 160, 84, 30,
                                   70, 8, 218, 119, 185, 201, 205, 62, 173, 90, 30, 88, 169, 196, 221, 49, 187, 226,
                                   121, 227, 247, 16, 102, 141, 11, 217, 19, 178, 155, 102, 211, 243, 62, 81, 103, 103,
                                   92, 27, 111, 34, 131, 55, 158, 73, 166, 26, 162, 121, 2, 234, 154, 166, 133, 165,
                                   149, 117, 63, 74, 96, 195, 91, 57, 161, 210, 4, 76, 101, 92, 240, 87, 171, 27, 199,
                                   117, 76, 211, 203, 227, 139, 133, 207, 60, 168, 158, 26, 213, 203, 139, 169, 233,
                                   194, 6, 19, 34, 126, 189, 229, 48, 71, 39, 26, 156, 27, 80, 73, 18, 47, 25, 163, 21,
                                   179, 213, 77, 219, 184, 177, 6, 79, 250, 17, 178, 114, 239, 170, 227, 43, 74, 173,
                                   167, 174, 38, 40, 83, 205, 219, 144, 210, 212, 218, 46, 238, 41, 128, 20, 90, 204,
                                   87, 85, 111, 195, 81, 163, 100, 247, 238, 63, 25, 37, 186, 122, 95, 48, 186, 215,
                                   134, 2, 144, 248, 225, 241, 174, 32, 31, 98, 74, 138, 195, 252, 171, 220, 156, 181,
                                   152, 14, 210, 127, 185, 29, 145, 230, 18, 117, 240, 156, 74, 234, 32, 73, 70, 37,
                                   52, 232, 153, 45, 13, 160, 227, 84, 47, 119, 97, 159, 132, 17, 189, 111, 241, 90,
                                   202, 134, 185, 55, 127, 217, 196, 105, 29, 175, 51, 244, 2, 232, 205, 188, 217, 82,
                                   135, 164, 44, 144, 64, 44, 118, 220, 52, 93, 222, 107, 55, 225, 173, 133, 82, 193,
                                   199, 93, 9, 62, 184, 94, 203, 222, 238, 82, 143, 219, 67, 128, 160, 201, 157, 18,
                                   69, 88, 167, 141, 250, 93, 214, 177, 185, 114, 214, 42, 115, 188, 241, 60, 180, 9,
                                   5, 84, 138, 151, 241, 126, 19, 200, 195, 223, 84, 202, 65, 125, 8, 64, 194, 30, 44,
                                   201, 87, 231, 75, 96, 154, 25, 108, 51, 25, 33, 45, 37, 69, 46, 75, 95, 9, 166, 217,
                                   127, 111, 71, 218, 20, 252, 168, 70, 214, 90, 64, 245, 70, 115, 120, 60, 147, 97,
                                   31, 33, 117, 19, 148, 90, 115, 93, 136, 97, 15, 82, 167, 22, 69, 234, 186, 14, 18,
                                   208, 4, 212, 109, 83, 228, 73, 126, 218, 174, 233, 137, 162, 25, 150, 196, 198, 227,
                                   220, 72, 125, 21, 84, 217, 67, 196, 122, 131, 159, 117, 50, 160, 206, 172, 199, 120,
                                   169, 4, 111, 42, 5, 139};
static uint8_t read_array[1024] = {0};

static inline void EEprom24lc16b_WriteProtection(uint8_t enable);

int16_t EEprom24lc16b_ReadByte(uint16_t addr) {
    uint8_t data = 0;
    if (HAL_I2C_Mem_Read(&hi2c1, 0xa0 | ((addr >> 7) & 14), addr & 0xFF,
                         I2C_MEMADD_SIZE_8BIT, &data, 1, 100) == HAL_OK) {
        //LL_mDelay(5);
        Delay_ms(5);
        return (int16_t) data;
    } else {
        Delay_ms(5);
        //LL_mDelay(5);
        return -1;
    }
}

uint8_t EEprom24lc16b_WriteByte(uint16_t addr, uint8_t data) {
    uint8_t result;
    EEprom24lc16b_WriteProtection(0);
    result = (uint8_t) HAL_I2C_Mem_Write(&hi2c1, 0xa0 | ((addr >> 7) & 14), addr & 0xFF,
                                         I2C_MEMADD_SIZE_8BIT, &data, 1, 1000);
    //LL_mDelay(10);
    Delay_ms(10);
    EEprom24lc16b_WriteProtection(1);
    return result;
}




uint8_t EEprom24lc16b_ReadByteArray(uint16_t addr, uint8_t *pData, uint16_t len) {
    int16_t temp;
    uint8_t attempt;
    for (uint16_t i = 0; i < len; i++){
        attempt = 0;
        temp = -1;
        while ((temp == -1) && (attempt < 3)){
            temp = EEprom24lc16b_ReadByte(addr + i);
            attempt += 1;
            if(temp >= 0){
                pData[i] = (uint8_t) temp;
            }
        }
    }
}

uint8_t EEprom24lc16b_WriteByteArray(uint16_t addr, uint8_t *pData, uint16_t len) {
    int16_t temp = -1;
    uint8_t attempt, result = 0;
    for (uint16_t i = 0; i < len; i++) {
        attempt = 0;
        temp = -1;
        while((temp != pData[i]) && attempt < 3){
            result = EEprom24lc16b_WriteByte(i + addr, pData[i]);
            if (result > 0)
                return result;
            temp = EEprom24lc16b_ReadByte(i + addr);
            attempt += 1;
        }
        if(attempt >= 3){
            return 4;
        }
    }
    return 0;
}


static void EEprom24lc16b_WriteProtection(uint8_t enable) {
    __ASM("nop");
    __ASM("nop");

    if (enable) {
        //LL_mDelay(10);
        Delay_ms(10);
        LL_GPIO_SetOutputPin(EE_WP_GPIO_Port, EE_WP_Pin);
    } else {
        LL_GPIO_ResetOutputPin(EE_WP_GPIO_Port, EE_WP_Pin);
    }
    __ASM("nop");
}
